<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script type="text/javascript" src="seedrandom.js" ></script>
    <script type="text/javascript" src="jquery.js" ></script>
    <script type="text/javascript" src="JScript.js" ></script>
    <style type="text/css">
        .questionRow
        {
            padding: 0.1em;
            font-family: "Bookman Old Style";
            font-size: 28px;
            display: block;
            margin: 0.2em;
        }
        .questionNum
        {
            font-family: Batang;
            font-size: 10px;
            display: inline-block;
            width: 5em;
        }
        #bookNo
        {
            width: 128px;
        }
    </style>
</head>
<body>
<h2>Math Workbook Creator </h2>
<script type="text/javascript">
    var currentExercise;
    var timerStart;
    function make_base_auth(user, password) {
        var tok = user + ':' + password;
        var hash = btoa(tok);
        return "Basic " + hash;
    }
    function recordScore(s,recordCallback) {
        //var baseUrl = "http://yudhi.iriscouch.com";
        //var baseUrl = "https://yudhi.couchappy.com";

        var baseUrl = "https://yudhi.cloudant.com";
        var now = new Date();
        var uuid1 = currentExercise.level + "x" + currentExercise.sheet + "x" + now.getTime() ;
        var datetime = now.toISOString();
        var docdata = "{level: " + '"' + currentExercise.level + '", '
            + " msecs: " + s.diff + ", acc: " + s.score + ", sheet: " + currentExercise.sheet 
            +", d: " + '"' + datetime + '"'
            + " }";
        docdata = '{"level" : "' + currentExercise.level + '", "sheet" : ' + currentExercise.sheet 
        + ', "msecs" : '+s.diff + ', "acc" : ' + s.score + ', "d" : "'+datetime +'"}'; 
        $.ajax({
            url: baseUrl + "/sheet_submission",
            data: docdata,
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            error: function() {
                alert('document save failed :' + docdata);
            },
            success: function (d1,st1,jq1) {
          //      alert('doc save ok : ' + docdata);
                recordCallback();
            }
        });           
    }
    function redrawExercise() {
        var ex = new Exercise($("#level").val(), $("#bookNo").val());
        $("#content0").html("<h3>" + ex.title() + "</h3>");
        for (i = 0; i < 12; i++) {
            var q = ex.getQuestion(i);
            var inputbox = "<input type='text' maxlength='4' id='q" + i + "' ></input>";
            $("#content0").append("<div class='questionRow'>" + "<span class='questionNum'>(" + (i + 1) + ")</span>" 
                + ex.questionString(q) + inputbox + "</div>");
        }
        currentExercise = ex;
        var d = new Date();
        timerStart = d.getTime();
    }
    function checkAnswers() {
        if (currentExercise) {
            var correct = 0;
            var incorrect = 0;
            for (i = 0; i < 12; i++) {
                var ans = $("#q" + i).val();
                var ansInteger = parseInt(ans, 10);
                var trueAns = currentExercise.questionAnswer(currentExercise.getQuestion(i));
                if (ansInteger == trueAns) {
                    correct = correct + 1;
                } else {
                    incorrect = incorrect + 1;
                }
            }
            var diff = 0;
            if (timerStart) {
                var d = new Date();
                diff = d.getTime() - timerStart;
            }
            return { "correct": correct, "incorrect": incorrect, "score": (correct * 100.0 / 12), "diff": diff };
        } else {
        return { "correct": 0, "incorrect": 0, "score": 0, "diff": 0 };
        }
    }
    $(function() {

        $("#next").click(function() {
            var bookNum = parseInt($("#bookNo").val(), 10);
            bookNum = bookNum + 1;
            $("#bookNo").val(bookNum);
            redrawExercise();
        });
        $("#next0").click(function() {
            var checkResult = checkAnswers();
            if (checkResult.score < 100) {
                recordScore(checkResult, function() {
                });
                alert('Skor ' + checkResult.score + '; Benar = ' + checkResult.correct + " Salah = " + checkResult.incorrect + ", periksa lagi!");
            } else {
                recordScore(checkResult, function() {
                    alert('Waktu anda ' + (checkResult.diff / 1000) + ' detik');
                    var bookNum = parseInt($("#bookNo").val(), 10);
                    bookNum = bookNum + 1;
                    $("#bookNo").val(bookNum);
                    redrawExercise();
                });
                
            }
        });

        $("#prev").click(function() {

            var bookNum = parseInt($("#bookNo").val(), 10);
            if (bookNum == 1) return;
            bookNum = bookNum - 1;
            $("#bookNo").val(bookNum);
            redrawExercise();
        });
    });
</script>
<div>
<select id="level"><option value="2A">2A</option><option value="A">A</option></select>
<input id="bookNo" type="text" value="1" maxlength="4" />    
</div>
    <input id="next" title="Next" 
        type="button" value="Next" />
        <input id="prev" title="Prev" 
        type="button" value="Prev" />
        

    <div id="content0">
    </div>

    <p>
    <input id="next0" title="Check Answer and Next" 
        type="button" value="Check Answer and Next" /></p>

</body>
</html>
